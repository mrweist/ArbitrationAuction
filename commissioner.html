<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbitration Auction - Commissioner Setup v1.9.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{--espn-red:#d00;--espn-red-dark:#a00;--espn-nav-dark:#282828;--espn-blue:#0b6ebd;--espn-text-primary:#333;--espn-text-secondary:#666;--espn-text-muted:#999;--espn-bg-page:#eaeaea;--espn-bg-card:#fff;--espn-bg-table-header:#f9f9f9;--espn-border:#e0e0e0;--espn-orange:#f7a500;--espn-success:#00703c;--espn-error:#c41e3a}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Roboto',sans-serif;background:var(--espn-bg-page);color:var(--espn-text-primary);font-size:15px;line-height:1.6}
    .header{background:var(--espn-red);height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 28px}.header-title{font-family:'Roboto Condensed',sans-serif;font-weight:700;font-size:1.6rem;color:white;text-transform:uppercase}
    .header-user{color:white;font-size:14px}.logout-btn{background:rgba(255,255,255,.2);color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;margin-left:12px}.logout-btn:hover{background:rgba(255,255,255,.3)}
    .nav{background:var(--espn-nav-dark);padding:0 28px;height:50px;display:flex;align-items:center}.nav-item{color:white;font-size:15px;padding:14px 20px;cursor:pointer}.nav-item.active{border-bottom:3px solid var(--espn-red)}
    .main-content{max-width:1200px;margin:32px auto;padding:0 28px}
    .page-header{margin-bottom:32px}.page-title{font-family:'Roboto Condensed',sans-serif;font-size:2.2rem;font-weight:700}.page-subtitle{color:var(--espn-text-secondary);margin-top:8px;font-size:16px}
    .card{background:var(--espn-bg-card);border:1px solid var(--espn-border);border-radius:8px;margin-bottom:28px}.card-header{background:var(--espn-bg-table-header);padding:16px 24px;font-family:'Roboto Condensed',sans-serif;font-weight:700;font-size:1.15rem;text-transform:uppercase;border-bottom:1px solid var(--espn-border)}.card-body{padding:24px}
    .form-group{margin-bottom:20px}.form-group label{display:block;font-size:13px;font-weight:600;color:var(--espn-text-secondary);text-transform:uppercase;margin-bottom:8px}.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px 16px;font-size:16px;border:1px solid var(--espn-border);border-radius:6px}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--espn-blue)}
    .form-hint{font-size:13px;color:var(--espn-text-muted);margin-top:6px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:16px 32px;font-size:15px;font-weight:600;text-transform:uppercase;border:none;border-radius:6px;cursor:pointer;font-family:'Roboto Condensed',sans-serif}.btn:disabled{opacity:.5;cursor:not-allowed}.btn-primary{background:var(--espn-red);color:white}.btn-primary:hover:not(:disabled){background:var(--espn-red-dark)}.btn-secondary{background:var(--espn-bg-table-header);color:var(--espn-text-primary);border:1px solid var(--espn-border)}.btn-blue{background:var(--espn-blue);color:white}.btn-success{background:var(--espn-success);color:white}
    .data-table{width:100%;border-collapse:collapse;font-size:15px}.data-table th{background:var(--espn-bg-table-header);padding:14px 16px;text-align:left;font-weight:600;text-transform:uppercase;font-size:12px;border-bottom:2px solid var(--espn-border)}.data-table td{padding:14px 16px;border-bottom:1px solid var(--espn-border)}.data-table input{padding:10px 12px;font-size:15px}.data-table input[type="number"]{width:90px;text-align:right}
    .steps{display:flex;justify-content:center;margin-bottom:40px;gap:12px;flex-wrap:wrap}.step{display:flex;align-items:center;gap:12px;padding:14px 24px;background:var(--espn-bg-card);border:2px solid var(--espn-border);border-radius:8px;cursor:pointer;font-size:15px}.step:hover{border-color:var(--espn-blue)}.step.active{background:var(--espn-blue);border-color:var(--espn-blue);color:white}.step.completed{border-color:var(--espn-success)}.step.completed .step-number{background:var(--espn-success);color:white}.step.disabled{opacity:.5;cursor:not-allowed}.step-number{width:32px;height:32px;border-radius:50%;background:var(--espn-bg-table-header);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}.step.active .step-number{background:rgba(255,255,255,.2)}.step-label{font-weight:600}
    .info-box{background:#e3f2fd;border:1px solid var(--espn-blue);border-radius:8px;padding:20px;margin-bottom:20px}.info-box h4{color:var(--espn-blue);margin-bottom:12px;font-size:16px}.info-box ol,.info-box ul{margin-left:24px}.info-box li{margin:10px 0;font-size:15px}.info-box code{background:rgba(0,0,0,.1);padding:2px 8px;border-radius:4px;font-size:13px}
    .success-box{background:#d4edda;border:1px solid var(--espn-success);border-radius:8px;padding:20px;margin-bottom:20px}.success-box h4{color:var(--espn-success);margin-bottom:8px}
    .error-box{background:#f8d7da;border:1px solid var(--espn-error);border-radius:8px;padding:20px;color:var(--espn-error)}
    .warning-box{background:#fff3cd;border:1px solid var(--espn-orange);border-radius:8px;padding:20px;margin-bottom:20px}.warning-box h4{color:#856404;margin-bottom:8px}
    .config-textarea{min-height:180px;font-family:monospace;font-size:13px}
    .script-box{background:#1e1e1e;border-radius:8px;padding:20px;margin:20px 0;max-height:300px;overflow-y:auto}.script-box pre{color:#d4d4d4;font-size:12px;white-space:pre-wrap;word-break:break-all}
    .arb-badge{display:inline-block;padding:4px 12px;border-radius:4px;font-size:13px;font-weight:700;color:white}.arb-badge.arb-3{background:var(--espn-red)}.arb-badge.arb-2{background:var(--espn-orange)}.arb-badge.arb-1{background:var(--espn-success)}
    .progress-bar{height:12px;background:var(--espn-bg-page);border-radius:6px;overflow:hidden;margin-top:16px}.progress-bar-fill{height:100%;background:var(--espn-blue)}
    .auction-link{display:flex;gap:16px;align-items:center;margin-top:20px}.auction-link input{flex:1;padding:16px;background:var(--espn-bg-table-header);border:1px solid var(--espn-border);border-radius:6px;font-size:15px}
    .scoring-inline{display:flex;flex-wrap:wrap;gap:14px;align-items:center}.scoring-inline .scoring-item{display:flex;align-items:center;gap:8px}.scoring-inline .scoring-item label{font-weight:600;font-size:14px;min-width:36px}.scoring-inline .scoring-item input{width:70px;padding:10px;text-align:center;font-size:15px;border:1px solid var(--espn-border);border-radius:4px}.scoring-inline .scoring-item.negative input{color:var(--espn-error)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}.modal{background:white;border-radius:8px;max-width:480px;width:90%}.modal-header{background:var(--espn-nav-dark);color:white;padding:20px 24px;font-family:'Roboto Condensed',sans-serif;font-weight:700;font-size:1.2rem}.modal-body{padding:28px}.modal-footer{padding:0 28px 28px;display:flex;gap:16px}.modal-footer .btn{flex:1}
    .copy-btn{background:var(--espn-blue);color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;margin-top:10px}.copy-btn:hover{background:var(--espn-blue-hover)}
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--espn-bg-page)}.login-card{background:white;border-radius:8px;padding:40px;max-width:420px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,.1)}.login-title{font-family:'Roboto Condensed',sans-serif;font-size:2rem;font-weight:700;text-align:center;margin-bottom:32px;color:var(--espn-red)}
    .login-tabs{display:flex;gap:8px;margin-bottom:24px}.login-tab{flex:1;padding:12px;background:var(--espn-bg-table-header);border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:15px}.login-tab.active{background:var(--espn-blue);color:white}
    .league-list{list-style:none;padding:0}.league-item{background:white;border:1px solid var(--espn-border);border-radius:8px;padding:20px;margin-bottom:16px;transition:all .2s;display:flex;align-items:center;gap:16px}.league-item:hover{border-color:var(--espn-blue);box-shadow:0 2px 8px rgba(0,0,0,.1)}.league-item-content{flex:1;cursor:pointer}.league-item-name{font-family:'Roboto Condensed',sans-serif;font-size:1.3rem;font-weight:700;color:var(--espn-blue);margin-bottom:8px}.league-item-meta{font-size:13px;color:var(--espn-text-muted)}.league-delete-btn{padding:8px 16px;font-size:13px;white-space:nowrap}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script type="text/babel">
const{useState,useEffect,useCallback}=React;
const PREV_YR=new Date().getFullYear()-1;
const STORE='arb_comm_session';
const fmt=n=>(n||0).toFixed(2);
const DEFAULT_HIT={'1B':1,'2B':2,'3B':3,'HR':4,'R':1,'RBI':1,'BB':1,'HBP':1,'SB':2};
const DEFAULT_PIT={'IP':2,'ER':-1,'K':1,'H':-0.5,'BB':-0.5,'HBP':-0.5,'W':10,'SV':8,'HD':7,'CG':5};
const genId=()=>{const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';return Array.from({length:8},()=>c[Math.floor(Math.random()*c.length)]).join('')};
const hashPassword=pw=>CryptoJS.SHA256(pw).toString();
const extractSheetId=url=>{const m=url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);return m?m[1]:null};
const calcPts=(s,hs,ps,isH,isP)=>{let pts=0;if(isH&&s){const h=s.H||0,d=s['2B']||0,t=s['3B']||0,hr=s.HR||0,sg=Math.max(0,h-d-t-hr);pts+=sg*(hs['1B']||0)+d*(hs['2B']||0)+t*(hs['3B']||0)+hr*(hs['HR']||0)+(s.R||0)*(hs['R']||0)+(s.RBI||0)*(hs['RBI']||0)+(s.BB||0)*(hs['BB']||0)+(s.HBP||0)*(hs['HBP']||0)+(s.SB||0)*(hs['SB']||0)}if(isP&&s){pts+=(s.IP||0)*(ps['IP']||0)+(s.ER||0)*(ps['ER']||0)+(s.SO||0)*(ps['K']||0)+(s.HA||0)*(ps['H']||0)+(s.BBA||0)*(ps['BB']||0)+(s.HBP_A||0)*(ps['HBP']||0)+(s.W||0)*(ps['W']||0)+(s.SV||0)*(ps['SV']||0)+(s.HD||0)*(ps['HD']||0)+(s.CG||0)*(ps['CG']||0)}return Math.round(pts*100)/100};
const downloadCSV=(c,f)=>{const b=new Blob([c],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u)};
const csvTemplate=()=>'Name,Team,Position,Owner,ArbYear,Type,Points\nJuan Soto,NYY,OF,Team 1,3,Hitter,906.50\nShohei Ohtani,LAD,DH/SP,Team 2,2,Both,1640.50\nCorbin Burnes,BAL,SP,Team 3,1,Pitcher,\n';

// Firebase config - hardcoded
const FIREBASE_CONFIG={apiKey:"AIzaSyC09xnc-SIXcz95O_tfVes0t_uF-AtMmwo",authDomain:"arbitration-auction.firebaseapp.com",databaseURL:"https://arbitration-auction-default-rtdb.europe-west1.firebasedatabase.app",projectId:"arbitration-auction",storageBucket:"arbitration-auction.firebasestorage.app",messagingSenderId:"105886135634",appId:"1:105886135634:web:ef411018b3017a4c23768b"};

const APPS_SCRIPT_CODE=`/**
 * ARBITRATION AUCTION - GOOGLE SHEETS SYNC
 * Paste this entire script into your Google Sheet's Apps Script editor
 */

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    if (action === 'init') return initializeSheet(data);
    else if (action === 'sync') return syncPlayer(data);
    else return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function doGet(e) {
  return jsonResponse({ success: true, message: 'Auction Sync Ready!' });
}

function initializeSheet(data) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const teamNames = data.teamNames || [];
  sheet.clear();
  const headers = ['Player', 'Team', 'Position', 'Owner', 'Arb Year', 'Winner', 'Decision', 'Price', 'Years', 'High Bid', 'High Bidder'];
  teamNames.forEach(name => headers.push(name));
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#282828');
  headerRange.setFontColor('#ffffff');
  sheet.setFrozenRows(1);
  return jsonResponse({ success: true, message: 'Sheet initialized' });
}

function syncPlayer(data) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const player = data.player;
  const teamNames = data.teamNames || [];
  if (!player) return jsonResponse({ success: false, error: 'No player data' });
  const row = [player.name||'', player.team||'', player.position||'', player.owner||'', player.arbYear||'', player.winner||'', player.decision||'', player.price||0, player.years||1, player.highBid||0, player.highBidder||''];
  teamNames.forEach(name => { row.push(player.bids && player.bids[name] !== undefined ? player.bids[name] : ''); });
  const values = sheet.getDataRange().getValues();
  const playerName = player.name || '';
  let rowIndex = -1;
  for (let i = 1; i < values.length; i++) { if (values[i][0] === playerName) { rowIndex = i + 1; break; } }
  if (rowIndex > 0) { sheet.getRange(rowIndex, 1, 1, row.length).setValues([row]); }
  else { sheet.appendRow(row); }
  return jsonResponse({ success: true, message: 'Player synced' });
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}`;

// Admin Login Component
function AdminLogin({onLogin}){
  const[isLogin,setIsLogin]=useState(true);
  const[username,setUsername]=useState('');
  const[password,setPassword]=useState('');
  const[error,setError]=useState('');
  const[loading,setLoading]=useState(false);
  const[db,setDb]=useState(null);

  useEffect(()=>{
    if(!firebase.apps.length)firebase.initializeApp(FIREBASE_CONFIG);
    setDb(firebase.database());
  },[]);

  const handleSubmit=async(e)=>{
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try{
      if(isLogin){
        const snapshot=await db.ref(`admins/${username}`).once('value');
        const admin=snapshot.val();
        if(!admin){setError('Admin account not found');setLoading(false);return}
        if(hashPassword(password)!==admin.passwordHash){setError('Incorrect password');setLoading(false);return}
        onLogin({username,...admin});
      }else{
        const snapshot=await db.ref(`admins/${username}`).once('value');
        if(snapshot.exists()){setError('Username already taken');setLoading(false);return}
        const adminData={username,passwordHash:hashPassword(password),createdAt:Date.now()};
        await db.ref(`admins/${username}`).set(adminData);
        onLogin({username,...adminData});
      }
    }catch(err){
      setError('Error: '+err.message);
      setLoading(false);
    }
  };

  return<div className="login-container"><div className="login-card"><div className="login-title">Admin Portal</div>
    <div className="login-tabs">
      <button className={`login-tab ${isLogin?'active':''}`} onClick={()=>setIsLogin(true)}>Login</button>
      <button className={`login-tab ${!isLogin?'active':''}`} onClick={()=>setIsLogin(false)}>Register</button>
    </div>
    <form onSubmit={handleSubmit}>
      <div className="form-group"><label>Username</label><input type="text" value={username} onChange={e=>setUsername(e.target.value)} required/></div>
      <div className="form-group"><label>Password</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} required/></div>
      {error&&<div className="error-box" style={{marginBottom:'20px'}}>{error}</div>}
      <button type="submit" className="btn btn-primary" style={{width:'100%'}} disabled={loading}>{loading?'Processing...':(isLogin?'Login':'Create Account')}</button>
    </form>
  </div></div>;
}

// League Dashboard Component
function LeagueDashboard({admin,onSelectLeague,onCreateNew,onLogout}){
  const[leagues,setLeagues]=useState([]);
  const[loading,setLoading]=useState(true);
  const[db,setDb]=useState(null);
  const[deleting,setDeleting]=useState(null);
  const[duplicating,setDuplicating]=useState(null);

  useEffect(()=>{
    if(!firebase.apps.length)firebase.initializeApp(FIREBASE_CONFIG);
    setDb(firebase.database());
  },[]);

  useEffect(()=>{
    if(!db)return;
    const loadLeagues=async()=>{
      try{
        const snapshot=await db.ref(`admins/${admin.username}/leagues`).once('value');
        const leaguesData=snapshot.val()||{};
        const userLeagues=Object.entries(leaguesData).map(([id,data])=>({id,...data}));
        setLeagues(userLeagues);
      }catch(err){
        console.error('Error loading leagues:',err);
      }
      setLoading(false);
    };
    loadLeagues();
  },[db,admin.username]);

  const handleDelete=async(lid,lname,e)=>{
    e.stopPropagation();
    if(!confirm('Delete "'+lname+'"? Cannot be undone.'))return;
    setDeleting(lid);
    try{
      await db.ref('auctions/'+lid).remove();
      await db.ref('admins/'+admin.username+'/leagues/'+lid).remove();
      setLeagues(leagues.filter(l=>l.id!==lid));
    }catch(err){
      alert('Error: '+err.message);
    }
    setDeleting(null);
  };

  const handleDuplicate=async(lid,lname,e)=>{
    e.stopPropagation();
    const newName=prompt('Enter name for duplicated league:',lname+' (Copy)');
    if(!newName)return;
    setDuplicating(lid);
    try{
      const snapshot=await db.ref('auctions/'+lid).once('value');
      const leagueData=snapshot.val();
      if(!leagueData){alert('League data not found');setDuplicating(null);return}
      const newId=genId();
      leagueData.leagueName=newName;
      leagueData.leagueId=newId;
      leagueData.createdAt=Date.now();
      await db.ref('auctions/'+newId).set(leagueData);
      await db.ref('admins/'+admin.username+'/leagues/'+newId).set({name:newName,createdAt:Date.now()});
      setLeagues([...leagues,{id:newId,name:newName,createdAt:Date.now()}]);
    }catch(err){
      alert('Error: '+err.message);
    }
    setDuplicating(null);
  };

  if(loading)return<div className="main-content">Loading...</div>;

  return<><header className="header"><div className="header-title">Arbitration Auction</div><div className="header-user">Admin: {admin.username}<button className="logout-btn" onClick={onLogout}>Logout</button></div></header>
    <main className="main-content">
      <div className="page-header"><div className="page-title">Your Leagues</div><div className="page-subtitle">Select a league to manage or create a new one</div></div>
      <div className="card"><div className="card-body"><button className="btn btn-primary" onClick={onCreateNew}>+ Create New League</button></div></div>
      {leagues.length>0?<ul className="league-list">{leagues.map(league=>{const status=league.phase==='completed'?'Completed':league.phase==='active'?'In Progress':league.phase==='created'?'Created':'Building';const statusColor=league.phase==='completed'?'var(--espn-success)':league.phase==='active'?'var(--espn-blue)':league.phase==='created'?'var(--espn-orange)':'var(--espn-text-muted)';const showEnter=league.phase==='created'||league.phase==='active'||league.phase==='completed';const showResults=league.phase==='active'||league.phase==='completed';const showTemplate=league.phase==='created'||league.phase==='active'||league.phase==='completed';return<li key={league.id} className="league-item"><div className="league-item-content" onClick={()=>onSelectLeague(league.id)}><div className="league-item-name">{league.name}</div><div className="league-item-meta"><span style={{color:statusColor,fontWeight:600}}>{status}</span> ‚Ä¢ Created: {new Date(league.createdAt).toLocaleDateString()}</div></div><div style={{display:'flex',gap:'8px',alignItems:'center'}}>{showEnter&&<button className="btn btn-primary league-delete-btn" onClick={(e)=>{e.stopPropagation();window.open('auction.html?id='+league.id,'_blank')}}>Enter Auction</button>}{showTemplate&&<button className="btn btn-secondary league-delete-btn" onClick={(e)=>{e.stopPropagation();downloadCSV(csvTemplate(),'player_template.csv')}}>üìÑ Template</button>}{showResults&&(league.sheetsUrl?<button className="btn btn-secondary league-delete-btn" onClick={(e)=>{e.stopPropagation();window.open(league.sheetsUrl,'_blank')}}>üìä Sheet</button>:<button className="btn btn-secondary league-delete-btn" onClick={(e)=>{e.stopPropagation();window.open('/auction.html?id='+league.id,'_blank')}}>üìÖ CSV</button>)}<button className="btn btn-blue league-delete-btn" onClick={(e)=>handleDuplicate(league.id,league.name,e)} disabled={duplicating===league.id}>{duplicating===league.id?'Duplicating...':'Duplicate'}</button><button className="btn btn-secondary league-delete-btn" onClick={(e)=>handleDelete(league.id,league.name,e)} disabled={deleting===league.id}>{deleting===league.id?'Deleting...':'Delete'}</button></div></li>})}</ul>
      :<div className="info-box"><h4>No leagues yet</h4><p>Create your first league to get started!</p></div>}
    </main>
  </>;
}

// Commissioner Setup Component (existing functionality)
function CommissionerSetup({admin,leagueId,onComplete,onBack}){
  const[step,setStep]=useState(1);
  const[done,setDone]=useState([]);
  const[db,setDb]=useState(null);
  const[sheetUrl,setSheetUrl]=useState('');
  const[sheetId,setSheetId]=useState('');
  const[scriptUrl,setScriptUrl]=useState('');
  const[sheetStatus,setSheetStatus]=useState('pending');
  const[sheetErr,setSheetErr]=useState('');
  const[league,setLeague]=useState('');
  const[leagueCode,setLeagueCode]=useState('');
  const[commCode,setCommCode]=useState('');
  const[commName,setCommName]=useState('');
  const[timer,setTimer]=useState(120);
  const[hitScore,setHitScore]=useState(DEFAULT_HIT);
  const[pitScore,setPitScore]=useState(DEFAULT_PIT);
  const[teams,setTeams]=useState(Array.from({length:12},(_,i)=>({id:i+1,name:`Team ${i+1}`,cap:100,sal:0,spots:5,isComm:i===0})));
  const[players,setPlayers]=useState([]);
  const[playerTxt,setPlayerTxt]=useState('');
  const[fetching,setFetching]=useState(false);
  const[fetchProg,setFetchProg]=useState({c:0,t:0});
  const[aucId,setAucId]=useState(null);
  const[created,setCreated]=useState(false);
  const[copied,setCopied]=useState(false);
  const[phase,setPhase]=useState('building');

  useEffect(()=>{
    if(!firebase.apps.length)firebase.initializeApp(FIREBASE_CONFIG);
    setDb(firebase.database());
  },[]);

  useEffect(()=>{if(sheetUrl){const id=extractSheetId(sheetUrl);setSheetId(id||'')}},[sheetUrl]);

  useEffect(()=>{
    if(leagueId&&db){
      db.ref(`auctions/${leagueId}`).once('value',snap=>{
        const d=snap.val();
        if(d){
          setLeague(d.leagueName||'');
          setLeagueCode(d.leagueAccessCode||'');
          setCommCode(d.commissionerAccessCode||'');
          setCommName(d.commissionerName||'');
          setTimer(d.timerDuration||120);
          setHitScore(d.hittingScoring||DEFAULT_HIT);
          setPitScore(d.pitchingScoring||DEFAULT_PIT);
          if(d.teams){const tArr=Object.values(d.teams).map((t,i)=>({id:i+1,name:t.name,cap:t.cap||t.salaryCap||100,sal:t.sal||t.currentSalary||0,spots:t.spots||t.spotsAvailable||5,isComm:t.isCommissioner||t.isComm||false}));setTeams(tArr)}
          if(d.players){setPlayers(d.players.map(p=>({...p})))}
          if(d.sheetsConfig){setScriptUrl(d.sheetsConfig.scriptUrl||'');setSheetUrl(d.sheetsConfig.sheetUrl||'');setSheetId(d.sheetsConfig.sheetId||'')}
          const ph=d.phase||'created';
          setPhase(ph);
          if(ph!=='building'){setAucId(leagueId);setCreated(true);setDone([1,2,3,4,5]);setStep(5)}else{setDone([1,2,3,4])}
        }
      });
    }
  },[leagueId,db]);

  const testSheets=async()=>{
    setSheetStatus('testing');setSheetErr('');
    if(!scriptUrl){setSheetErr('Enter the Apps Script URL');setSheetStatus('error');return}
    if(!scriptUrl.includes('script.google.com')){setSheetErr('Invalid Apps Script URL');setSheetStatus('error');return}
    try{
      await fetch(scriptUrl,{method:'GET',mode:'no-cors'});
      setSheetStatus('connected');
    }catch(e){setSheetErr('Could not reach script. Make sure it\'s deployed.');setSheetStatus('error')}
  };

  const copyScript=()=>{navigator.clipboard.writeText(APPS_SCRIPT_CODE);setCopied(true);setTimeout(()=>setCopied(false),2000)};
  const goStep=s=>{if(s<=step||done.includes(s-1))setStep(s)};
  const finish=s=>{if(!done.includes(s))setDone([...done,s]);setStep(s+1)};
  const updTeam=(id,f,v)=>{setTeams(t=>t.map(x=>x.id===id?{...x,[f]:f==='name'?v:f==='isComm'?v:parseFloat(v)||0}:x))};
  const updHit=(k,v)=>{setHitScore(s=>({...s,[k]:parseFloat(v)||0}))};
  const updPit=(k,v)=>{setPitScore(s=>({...s,[k]:parseFloat(v)||0}))};

  const parsePlayers=txt=>{const lines=txt.trim().split('\n');if(lines.length<2)return[];const hdrs=lines[0].toLowerCase().split(',').map(h=>h.trim());const out=[];for(let i=1;i<lines.length;i++){const vals=lines[i].split(',').map(v=>v.trim());if(vals.length<3)continue;const row={};hdrs.forEach((h,j)=>{row[h]=vals[j]||''});const typeRaw=(row.type||'').toLowerCase().trim();const pos=(row.position||row.pos||'').toUpperCase();const team=(row.team||'').toUpperCase();let type=typeRaw;let isH=true;let isP=false;if(typeRaw==='hitter'){isH=true;isP=false;type='hitter'}else if(typeRaw==='pitcher'){isH=false;isP=true;type='pitcher'}else if(typeRaw==='both'){isH=true;isP=true;type='both'}else if(pos){const posIsP=['SP','RP','P'].some(p=>pos.includes(p));isP=posIsP;isH=!posIsP||pos.includes('/');type=isH&&isP?'both':isP?'pitcher':'hitter'}else{type='TBD'}out.push({id:i,name:row.name||'',team:team||'TBD',position:pos||'TBD',owner:row.owner||'',arbYear:parseInt(row.arbyear||row.arb||'1')||1,type:type,isHitter:isH,isPitcher:isP,fantasyPoints:parseFloat(row.points||'0')||0,needsDetection:!team||!pos||!typeRaw})}return out};
  const handleFile=e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{const txt=ev.target.result;setPlayerTxt(txt);const p=parsePlayers(txt);if(p.length>0){validateOwners(p);setPlayers(p)}};r.readAsText(f)}};
  const handleTxt=txt=>{setPlayerTxt(txt);const p=parsePlayers(txt);if(p.length>0){validateOwners(p);setPlayers(p)}};

  const validateOwners=pls=>{const teamNames=teams.map(t=>t.name.toLowerCase());const invalidOwners=new Set();pls.forEach(p=>{if(p.owner&&!teamNames.includes(p.owner.toLowerCase()))invalidOwners.add(p.owner)});if(invalidOwners.size>0)alert(`‚ö†Ô∏è WARNING: Some players have owners that don\'t match team names:\n\n${Array.from(invalidOwners).join(', ')}\n\nPlease verify team names match.`)};
  const updPts=(id,pts)=>{setPlayers(p=>p.map(x=>x.id===id?{...x,fantasyPoints:parseFloat(pts)||0}:x))};

  const downloadTeamsCSV=()=>{let csv='Name,Commissioner,Cap,Salary,Spots\n';teams.forEach(t=>{csv+=`"${t.name}",${t.isComm?'Yes':'No'},${t.cap},${t.sal},${t.spots}\n`});downloadCSV(csv,'teams.csv')};

  const handleTeamsFile=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const txt=ev.target.result;const lines=txt.trim().split('\n');if(lines.length<2)return alert('CSV must have header and at least one team');const hdrs=lines[0].toLowerCase().split(',').map(h=>h.trim());const nameIdx=hdrs.findIndex(h=>h.includes('name'));const commIdx=hdrs.findIndex(h=>h.includes('comm'));const capIdx=hdrs.findIndex(h=>h.includes('cap'));const salIdx=hdrs.findIndex(h=>h.includes('sal'));const spotsIdx=hdrs.findIndex(h=>h.includes('spot'));if(nameIdx===-1)return alert('CSV must have Name column');const newTeams=[];for(let i=1;i<lines.length;i++){const vals=lines[i].split(',').map(v=>v.trim().replace(/^"|"$/g,''));if(vals.length<2)continue;newTeams.push({id:genId(),name:vals[nameIdx]||`Team ${i}`,isComm:commIdx!==-1&&(vals[commIdx].toLowerCase()==='yes'||vals[commIdx]==='true'),cap:capIdx!==-1?parseFloat(vals[capIdx])||DEFAULT_CAP:DEFAULT_CAP,sal:salIdx!==-1?parseFloat(vals[salIdx])||DEFAULT_SAL:DEFAULT_SAL,spots:spotsIdx!==-1?parseInt(vals[spotsIdx])||DEFAULT_SPOTS:DEFAULT_SPOTS})}if(newTeams.length>0){setTeams(newTeams);alert(`Imported ${newTeams.length} teams`)}}catch(err){alert('Error parsing CSV: '+err.message)}};r.readAsText(f)};

  const fetchMLB=async pl=>{try{const sr=await fetch(`https://statsapi.mlb.com/api/v1/people/search?names=${encodeURIComponent(pl.name)}&sportIds=1&active=true`);const sd=await sr.json();if(!sd.people?.length)return null;const pid=sd.people[0].id;const dr=await fetch(`https://statsapi.mlb.com/api/v1/people/${pid}?hydrate=currentTeam`);const dd=await dr.json();if(!dd.people?.length)return null;const mp=dd.people[0];let teamAbbr='TBD';if(mp.currentTeam?.id){const tr=await fetch(`https://statsapi.mlb.com/api/v1/teams/${mp.currentTeam.id}`);const td=await tr.json();if(td.teams?.[0]?.abbreviation)teamAbbr=td.teams[0].abbreviation}const st={hit:null,pit:null,team:teamAbbr,position:mp.primaryPosition?.abbreviation||pl.position};const hr=await fetch(`https://statsapi.mlb.com/api/v1/people/${pid}/stats?stats=season&season=${PREV_YR}&group=hitting&sportId=1`);const hd=await hr.json();if(hd.stats?.[0]?.splits?.[0]?.stat){const s=hd.stats[0].splits[0].stat;st.hit={H:s.hits||0,'2B':s.doubles||0,'3B':s.triples||0,HR:s.homeRuns||0,RBI:s.rbi||0,R:s.runs||0,SB:s.stolenBases||0,BB:s.baseOnBalls||0,HBP:s.hitByPitch||0}}const pr=await fetch(`https://statsapi.mlb.com/api/v1/people/${pid}/stats?stats=season&season=${PREV_YR}&group=pitching&sportId=1`);const pd=await pr.json();if(pd.stats?.[0]?.splits?.[0]?.stat){const s=pd.stats[0].splits[0].stat;st.pit={IP:parseFloat(s.inningsPitched)||0,SO:s.strikeOuts||0,HA:s.hits||0,BBA:s.baseOnBalls||0,HBP_A:s.hitBatsmen||0,ER:s.earnedRuns||0,W:s.wins||0,SV:s.saves||0,HD:s.holds||0,CG:s.completeGames||0}}return st}catch(e){return null}};

  const fetchAll=async()=>{setFetching(true);setFetchProg({c:0,t:players.length});const upd=[...players];for(let i=0;i<upd.length;i++){setFetchProg({c:i+1,t:upd.length});const st=await fetchMLB(upd[i]);let pts=0;if(st){if(st.team&&st.team!=='TBD'){upd[i].team=st.team}if(st.position&&st.position!=='TBD'){upd[i].position=st.position}const hadHit=st.hit&&Object.values(st.hit).some(v=>v>0);const hadPit=st.pit&&(st.pit.IP>0||st.pit.SO>0);const typeIsTBD=upd[i].type==='TBD'||!upd[i].type;if(hadHit){pts+=calcPts(st.hit,hitScore,pitScore,true,false);upd[i].hittingStats=st.hit}if(hadPit){pts+=calcPts(st.pit,hitScore,pitScore,false,true);upd[i].pitchingStats=st.pit}if(typeIsTBD){if(hadHit&&hadPit){upd[i].type='both';upd[i].isHitter=true;upd[i].isPitcher=true}else if(hadPit){upd[i].type='pitcher';upd[i].isHitter=false;upd[i].isPitcher=true}else if(hadHit){upd[i].type='hitter';upd[i].isHitter=true;upd[i].isPitcher=false}else if(upd[i].position){const pos=upd[i].position.toUpperCase();if(pos==='P'||pos==='SP'||pos==='RP'){upd[i].type='pitcher';upd[i].isPitcher=true;upd[i].isHitter=false}else{upd[i].type='hitter';upd[i].isHitter=true;upd[i].isPitcher=false}}}upd[i].needsDetection=false}upd[i].fantasyPoints=pts;await new Promise(r=>setTimeout(r,150))}upd.sort((a,b)=>b.arbYear!==a.arbYear?b.arbYear-a.arbYear:b.fantasyPoints-a.fantasyPoints);setPlayers(upd);setFetching(false)};

  const createAuc=async()=>{
    const id=leagueId||genId();
    // No commissioner password needed - using access codes only
    const sorted=[...players].sort((a,b)=>b.arbYear!==a.arbYear?b.arbYear-a.arbYear:b.fantasyPoints-a.fantasyPoints);
    const tObj={};
    teams.forEach((t,i)=>{tObj[`team_${i+1}`]={...t,joined:false,claimedBy:null,passwordHash:''}});
    const sheetsCfg=scriptUrl?{scriptUrl,sheetUrl,sheetId}:null;
    const data={
      leagueName:league,
      leagueAccessCode:leagueCode,
      commissionerAccessCode:commCode,
      commissionerName:commName,
      timerDuration:timer,
      teams:tObj,
      players:sorted.map((p,i)=>({...p,status:'pending',order:i})),
      hittingScoring:hitScore,
      pitchingScoring:pitScore,
      sheetsConfig:sheetsCfg,
      currentPlayerIndex:0,
      phase:'created',
      createdBy:admin.username,
      createdAt:Date.now(),
      bidHistory:[]
    };
    if(db){
      await db.ref(`auctions/${id}`).set(data);
      await db.ref(`admins/${admin.username}/leagues/${id}`).set({name:league,createdAt:Date.now(),phase:'created',sheetsUrl:sheetUrl||null});
      setAucId(id);
      setCreated(true);
      setDone([...done,5]);
    }
  };

  const unlaunchAuc=async()=>{if(!confirm('WARNING: All auction data will be lost if the auction has been started.\n\nThis will return the league to Building state. All settings will be preserved.\n\nContinue?'))return;if(db&&(aucId||leagueId)){await db.ref(`auctions/${aucId||leagueId}`).update({phase:'building',currentPlayerIndex:0,bidHistory:[]});await db.ref(`admins/${admin.username}/leagues/${aucId||leagueId}`).update({phase:'building'});setPhase('building');setCreated(false);setAucId(null);setDone(done.filter(s=>s!==5))}};  

  const getUrl=()=>{const u=window.location.href;const i=u.lastIndexOf('/');return`${u.substring(0,i+1)}auction.html?league=${aucId||leagueId}`};
  const enter=()=>{window.open(getUrl()+'&role=commissioner','_blank')};

  const resetTab=()=>{
    if(step===1){setScriptUrl('');setSheetUrl('');setSheetId('');setSheetStatus('pending');setSheetErr('')}
    if(step===2){setHitScore(DEFAULT_HIT);setPitScore(DEFAULT_PIT)}
    if(step===3){setLeague('');setLeagueCode('');setCommCode('');setCommName('');setCommPw('');setTimer(120);setTeams(Array.from({length:12},(_,i)=>({id:i+1,name:`Team ${i+1}`,cap:100,sal:0,spots:5,isComm:i===0})))}
    if(step===4){setPlayers([]);setPlayerTxt('')}
  };

  const resetAll=()=>{
    if(confirm('Reset all settings? This cannot be undone.')){
      setStep(1);setDone([]);setScriptUrl('');setSheetUrl('');setSheetId('');setSheetStatus('pending');setSheetErr('');setLeague('');setLeagueCode('');setCommCode('');setCommName('');setCommPw('');setTimer(120);setHitScore(DEFAULT_HIT);setPitScore(DEFAULT_PIT);setTeams(Array.from({length:12},(_,i)=>({id:i+1,name:`Team ${i+1}`,cap:100,sal:0,spots:5,isComm:i===0})));setPlayers([]);setPlayerTxt('');setAucId(null);setCreated(false)
    }
  };

  return<><header className="header"><div className="header-title">Arbitration Auction</div><div className="header-user" style={{display:'flex',gap:'12px'}}><button className="logout-btn" onClick={onBack}>‚Üê Dashboard</button><button className="logout-btn" onClick={resetTab}>Reset Tab</button><button className="logout-btn" onClick={resetAll}>Reset All</button></div></header><nav className="nav"><div className="nav-item active">Commissioner Setup</div></nav>
    <main className="main-content">
      <div className="steps">{[1,2,3,4,5].map(s=><div key={s} className={`step ${step===s?'active':''} ${done.includes(s)?'completed':''} ${s>step&&!done.includes(s-1)?'disabled':''}`} onClick={()=>goStep(s)}><span className="step-number">{done.includes(s)?'‚úì':s}</span><span className="step-label">{s===1&&'Google Sheets'}{s===2&&'Scoring'}{s===3&&'League'}{s===4&&'Players'}{s===5&&'Launch'}</span></div>)}</div>

      {step===1&&<><div className="page-header"><h1 className="page-title">Google Sheets Setup</h1><p className="page-subtitle">Live sync auction results to Google Sheets (optional but recommended)</p></div>
        <div className="card"><div className="card-header">Google Sheets Configuration</div><div className="card-body">
          <div className="info-box"><h4>üìã Setup Instructions</h4><ol>
            <li>Create a new Google Sheet at <a href="https://sheets.google.com" target="_blank">sheets.google.com</a></li>
            <li>In your sheet, go to <strong>Extensions ‚Üí Apps Script</strong></li>
            <li>Delete any existing code and paste the script below</li>
            <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
            <li>Select type: <strong>Web app</strong></li>
            <li>Set "Who has access" to <strong>Anyone</strong></li>
            <li>Click <strong>Deploy</strong> and authorize when prompted</li>
            <li>Copy the <strong>Web app URL</strong> and paste below</li>
          </ol></div>

          <div className="form-group">
            <label>1. Copy This Script</label>
            <div className="script-box"><pre>{APPS_SCRIPT_CODE}</pre></div>
            <button className="copy-btn" onClick={copyScript}>{copied?'‚úì Copied!':'üìã Copy Script to Clipboard'}</button>
          </div>

          <div className="form-group">
            <label>2. Paste Your Web App URL</label>
            <input value={scriptUrl} onChange={e=>setScriptUrl(e.target.value)} placeholder="https://script.google.com/macros/s/.../exec"/>
            <div className="form-hint">This URL is shown after you deploy the Apps Script</div>
          </div>

          <div className="form-group">
            <label>3. Paste Your Google Sheet URL (optional, for easy access)</label>
            <input value={sheetUrl} onChange={e=>setSheetUrl(e.target.value)} placeholder="https://docs.google.com/spreadsheets/d/.../edit"/>
          </div>

          {scriptUrl&&<button className="btn btn-blue" onClick={testSheets}>{sheetStatus==='testing'?'Testing...':'Verify Connection'}</button>}
          {sheetStatus==='connected'&&<div className="success-box" style={{marginTop:'20px'}}><h4>‚úì Google Sheets Ready!</h4><p>Your auction results will sync automatically.</p></div>}
          {sheetStatus==='error'&&<div className="error-box" style={{marginTop:'20px'}}>{sheetErr}</div>}
        </div></div>
        <button className="btn btn-primary" onClick={()=>finish(1)}>{scriptUrl?'Continue ‚Üí':'Skip for Now ‚Üí'}</button>
      </>}

      {step===2&&<><div className="page-header"><h1 className="page-title">Scoring Settings</h1><p className="page-subtitle">Configure fantasy point values</p></div>
        <div className="card"><div className="card-header">‚öæ Hitting</div><div className="card-body"><div className="scoring-inline">{Object.entries(hitScore).map(([k,v])=><div key={k} className={`scoring-item ${v<0?'negative':''}`}><label>{k}</label><input type="number" step="0.5" value={v} onChange={e=>updHit(k,e.target.value)}/></div>)}</div></div></div>
        <div className="card"><div className="card-header">‚öæ Pitching</div><div className="card-body"><div className="scoring-inline">{Object.entries(pitScore).map(([k,v])=><div key={k} className={`scoring-item ${v<0?'negative':''}`}><label>{k}</label><input type="number" step="0.5" value={v} onChange={e=>updPit(k,e.target.value)}/></div>)}</div><div className="form-hint" style={{marginTop:'16px'}}>Negative = subtract points</div></div></div>
        <div style={{display:'flex',gap:'16px'}}><button className="btn btn-secondary" onClick={()=>setStep(1)}>‚Üê Back</button><button className="btn btn-primary" onClick={()=>finish(2)}>Continue ‚Üí</button></div>
      </>}

      {step===3&&<><div className="page-header"><h1 className="page-title">League Settings</h1></div>
        <div className="card"><div className="card-header">General</div><div className="card-body">
          <div className="form-row">
            <div className="form-group"><label>League Name</label><input value={league} onChange={e=>setLeague(e.target.value)}/></div>
            <div className="form-group"><label>Commissioner</label><input value={commName} onChange={e=>setCommName(e.target.value)}/></div>
          </div>
          <div className="form-row">
            <div className="form-group"><label>League Access Code</label><input value={leagueCode} onChange={e=>setLeagueCode(e.target.value)} placeholder="All users need this"/><div className="form-hint">Share with all league members</div></div>
            <div className="form-group"><label>Commissioner Access Code</label><input value={commCode} onChange={e=>setCommCode(e.target.value)} placeholder="Only commissioners need this"/><div className="form-hint">Keep this private</div></div>
          </div>
          <div className="form-group"><label>Timer (sec)</label><input type="number" value={timer} onChange={e=>setTimer(parseInt(e.target.value)||120)}/><div className="form-hint">Countdown duration for each player</div></div>
        </div></div>
        <div className="card"><div className="card-header">Teams</div><div className="card-body">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}><p style={{color:'var(--espn-text-secondary)',margin:0}}>Max Bid = Cap - Salary - Spots + 1. Min salary $1.00.</p><div style={{display:'flex',gap:'8px'}}><input type="file" accept=".csv" onChange={handleTeamsFile} style={{display:'none'}} id="teamsUp"/><label htmlFor="teamsUp" className="btn btn-secondary" style={{cursor:'pointer',padding:'8px 16px',fontSize:'14px'}}>üìÅ Upload</label><button className="btn btn-secondary" onClick={downloadTeamsCSV} style={{padding:'8px 16px',fontSize:'14px'}}>üì• Download</button></div></div>
          <div style={{overflowX:'auto'}}><table className="data-table"><thead><tr><th>#</th><th>Name</th><th>Comm</th><th>Cap</th><th>Salary</th><th>Spots</th><th>Avail</th><th>Max</th></tr></thead><tbody>
            {teams.map((t,i)=>{const av=t.cap-t.sal;const mx=Math.max(0,t.cap-t.sal-t.spots+1);return<tr key={t.id}><td>{i+1}</td><td><input type="text" value={t.name} onChange={e=>updTeam(t.id,'name',e.target.value)}/></td><td style={{textAlign:'center'}}><input type="checkbox" checked={t.isComm||false} onChange={e=>updTeam(t.id,'isComm',e.target.checked)} style={{width:'20px',height:'20px'}}/></td><td><input type="number" value={t.cap} onChange={e=>updTeam(t.id,'cap',e.target.value)}/></td><td><input type="number" value={t.sal} onChange={e=>updTeam(t.id,'sal',e.target.value)}/></td><td><input type="number" value={t.spots} onChange={e=>updTeam(t.id,'spots',e.target.value)} min="1"/></td><td style={{color:'var(--espn-success)',fontWeight:600}}>${fmt(av)}</td><td style={{color:'var(--espn-blue)',fontWeight:600}}>${fmt(mx)}</td></tr>})}
          </tbody></table></div>
        </div></div>
        <div style={{display:'flex',gap:'16px'}}><button className="btn btn-secondary" onClick={()=>setStep(2)}>‚Üê Back</button><button className="btn btn-primary" onClick={()=>finish(3)} disabled={!league||!leagueCode||!commCode}>Continue ‚Üí</button></div>
      </>}

      {step===4&&<><div className="page-header"><h1 className="page-title">Players</h1></div>
        <div className="card"><div className="card-header">Import</div><div className="card-body">
          <div style={{display:'flex',gap:'16px',marginBottom:'20px',flexWrap:'wrap'}}><input type="file" accept=".csv" onChange={handleFile} style={{display:'none'}} id="csvUp"/><label htmlFor="csvUp" className="btn btn-secondary" style={{cursor:'pointer'}}>üìÅ Upload CSV</label><button className="btn btn-secondary" onClick={()=>downloadCSV(csvTemplate(),'template.csv')}>üì• Template</button><button className="btn btn-blue" onClick={fetchAll} disabled={players.length===0||fetching}>{fetching?`Fetching ${fetchProg.c}/${fetchProg.t}...`:'üîÑ Fetch MLB Stats'}</button>{players.length>0&&<button className="btn btn-secondary" onClick={()=>{if(confirm('Clear all players?')){setPlayers([]);setPlayerTxt('')}}}>‚ùå Clear Players</button>}</div>
          {fetching&&<div className="progress-bar"><div className="progress-bar-fill" style={{width:`${(fetchProg.c/fetchProg.t)*100}%`}}/></div>}
          <div className="form-group"><label>Or Paste CSV</label><textarea style={{minHeight:'140px',fontFamily:'monospace'}} value={playerTxt} onChange={e=>handleTxt(e.target.value)} placeholder="Name,Owner,ArbYear\n(Team, Position, Type will be auto-detected)"/><div className="form-hint">Minimum required: Name, Owner, ArbYear. Click "Fetch MLB Stats" to auto-detect Team, Position, Type, and Points.</div></div>
        </div></div>
        {players.length>0&&<div className="card"><div className="card-header">Players ({players.length})</div><div className="card-body"><div style={{overflowX:'auto',maxHeight:'500px'}}><table className="data-table"><thead><tr><th>Name</th><th>Team</th><th>Pos</th><th>Owner</th><th>Arb</th><th>Type</th><th>Points</th></tr></thead><tbody>
          {players.map(p=><tr key={p.id}><td style={{fontWeight:500}}>{p.name}</td><td>{p.team}</td><td>{p.position}</td><td>{p.owner}</td><td><span className={`arb-badge arb-${p.arbYear}`}>ARB {p.arbYear}</span></td><td style={{textTransform:'capitalize'}}>{p.type}</td><td><input type="number" step="0.01" value={p.fantasyPoints||0} onChange={e=>updPts(p.id,e.target.value)} style={{width:'100px'}}/></td></tr>)}
        </tbody></table></div></div></div>}
        <div style={{display:'flex',gap:'16px'}}><button className="btn btn-secondary" onClick={()=>setStep(3)}>‚Üê Back</button><button className="btn btn-primary" onClick={()=>finish(4)} disabled={players.length===0}>Continue ‚Üí</button></div>
      </>}

      {step===5&&<><div className="page-header"><h1 className="page-title">{league||'League'}</h1><p className="page-subtitle">League ID: {aucId||leagueId||'Pending'} ‚Ä¢ {created?<span style={{color:'var(--espn-orange)'}}>Created</span>:<span>Not Created</span>}</p></div>
        {!created?<><div className="card"><div className="card-header">Summary</div><div className="card-body">
          <p style={{marginBottom:'10px'}}><strong>League:</strong> {league}</p>
          <p style={{marginBottom:'10px'}}><strong>Teams:</strong> {teams.length}</p>
          <p style={{marginBottom:'10px'}}><strong>Players:</strong> {players.length}</p>
          <p style={{marginBottom:'10px'}}><strong>Timer:</strong> {timer}s</p>
          <p><strong>Google Sheets:</strong> {scriptUrl?'‚úì Configured':'Not configured'}</p>
        </div></div>
        <button className="btn btn-success" onClick={createAuc} style={{width:'100%',padding:'20px',fontSize:'18px'}}>üöÄ Create Auction</button></>
        :<><div className="card"><div className="card-header">Auction Link</div><div className="card-body">
          <p style={{marginBottom:'12px'}}>Share this link with your league members to join the auction:</p>
          <div className="auction-link"><input value={getUrl()} readOnly/><button className="btn btn-secondary" onClick={()=>navigator.clipboard.writeText(getUrl())}>Copy Link</button></div>
          <button className="btn btn-primary" onClick={enter} style={{marginTop:'20px',width:'100%',fontSize:'16px'}}>ENTER AUCTION ‚Üí</button>
        </div></div>
        <div className="card"><div className="card-header">Access Codes</div><div className="card-body">
          <div style={{marginBottom:'24px'}}><p style={{fontSize:'12px',fontWeight:'600',color:'var(--espn-text-secondary)',textTransform:'uppercase',marginBottom:'8px'}}>League Access Code</p>
          <p style={{fontSize:'1.5rem',fontWeight:'700',color:'var(--espn-blue)',marginBottom:'4px'}}>{leagueCode}</p>
          <p style={{fontSize:'13px',color:'var(--espn-text-muted)'}}>Share with all league members</p></div>
          <div><p style={{fontSize:'12px',fontWeight:'600',color:'var(--espn-text-secondary)',textTransform:'uppercase',marginBottom:'8px'}}>Commissioner Access Code</p>
          <p style={{fontSize:'1.5rem',fontWeight:'700',color:'var(--espn-orange)',marginBottom:'4px'}}>{commCode}</p>
          <p style={{fontSize:'13px',color:'var(--espn-text-muted)'}}>Only for commissioners</p></div>
        </div></div>
        <div className="card"><div className="card-header">League Summary</div><div className="card-body">
          <div className="form-row"><div><p style={{fontSize:'13px',color:'var(--espn-text-secondary)',marginBottom:'4px'}}>Teams:</p><p style={{fontSize:'1.2rem',fontWeight:'600'}}>{teams.length}</p></div>
          <div><p style={{fontSize:'13px',color:'var(--espn-text-secondary)',marginBottom:'4px'}}>Players:</p><p style={{fontSize:'1.2rem',fontWeight:'600'}}>{players.length}</p></div></div>
          <div className="form-row" style={{marginTop:'16px'}}><div><p style={{fontSize:'13px',color:'var(--espn-text-secondary)',marginBottom:'4px'}}>Timer:</p><p style={{fontSize:'1.2rem',fontWeight:'600'}}>{timer}s</p></div>
          <div><p style={{fontSize:'13px',color:'var(--espn-text-secondary)',marginBottom:'4px'}}>Google Sheets:</p><p style={{fontSize:'1.2rem',fontWeight:'600'}}>{scriptUrl?'‚úì Configured':'Not configured'}</p></div></div>
        </div></div>
        {(phase==='active'||phase==='completed')&&<div className="card"><div className="card-header">Results</div><div className="card-body">
          <p style={{marginBottom:'16px',color:'var(--espn-text-secondary)'}}>View auction results:</p>
          <div style={{display:'flex',gap:'12px',flexWrap:'wrap'}}>{sheetUrl&&<button className="btn btn-secondary" onClick={()=>window.open(sheetUrl,'_blank')} style={{flex:'1'}}>üìä Google Sheet</button>}<button className="btn btn-secondary" onClick={()=>downloadCSV(players.map(p=>`${p.name},${p.team||''},${p.position||''},${p.owner||''},${p.arbYear||''},${p.winner||''},${p.decision||''},${p.price||''},${p.years||''},${p.highBid||''},${p.highBidder||''}`).join('\n'),'results.csv')} style={{flex:'1'}}>üìÖ Download CSV</button></div>
        </div></div>}
        <div style={{display:'flex',gap:'16px',marginTop:'20px'}}><button className="btn btn-secondary" onClick={onBack} style={{flex:'1'}}>‚Üê BACK TO DASHBOARD</button>
        <button className="btn btn-blue" onClick={()=>goStep(3)} style={{flex:'1'}}>EDIT LEAGUE SETTINGS</button></div>
        <button className="btn btn-secondary" onClick={unlaunchAuc} style={{width:'100%',marginTop:'16px'}}>Unlaunch Auction</button></>}
      </>}
    </main>
  </>;
}

// League Management Component
function LeagueManagement({leagueId,onBack,onEdit}){
  const[league,setLeague]=useState(null);
  const[db,setDb]=useState(null);
  const[copied,setCopied]=useState(false);

  useEffect(()=>{
    if(!firebase.apps.length)firebase.initializeApp(FIREBASE_CONFIG);
    setDb(firebase.database());
  },[]);

  useEffect(()=>{
    if(leagueId&&db){
      db.ref(`auctions/${leagueId}`).once('value',snap=>{
        const d=snap.val();
        if(d)setLeague({id:leagueId,...d});
      });
    }
  },[leagueId,db]);

  const getUrl=()=>`${window.location.href.substring(0,window.location.href.lastIndexOf('/')+1)}auction.html?league=${leagueId}`;
  const copyUrl=()=>{navigator.clipboard.writeText(getUrl());setCopied(true);setTimeout(()=>setCopied(false),2000)};
  const enterAuction=()=>{window.location.href=getUrl()+'&role=commissioner'};

  if(!league)return<div className="loading-screen"><div className="loading-spinner"/><p>Loading league...</p></div>;

  const status=league.phase==='completed'?'Completed':league.phase==='active'?'In Progress':'Created';
  const statusColor=league.phase==='completed'?'var(--espn-green)':league.phase==='active'?'var(--espn-blue)':'var(--espn-orange)';
  const hasResults=league.phase==='completed'||league.phase==='active';
  const sheetsUrl=league.sheetsConfig?.sheetUrl;
  
  return<><header className="header"><div className="header-title">League Management</div></header>
    <nav className="nav"><div className="nav-item active">{league.leagueName}</div></nav>
    <main className="main-content">
      <div className="page-header"><h1 className="page-title">{league.leagueName}</h1><p className="page-subtitle">League ID: {leagueId} ‚Ä¢ <span style={{color:statusColor,fontWeight:600}}>{status}</span></p></div>
      
      <div className="card"><div className="card-header">Auction Link</div><div className="card-body">
        <p style={{marginBottom:'16px',color:'var(--espn-text-secondary)'}}>Share this link with your league members to join the auction:</p>
        <div className="auction-link"><input value={getUrl()} readOnly/><button className="btn btn-secondary" onClick={copyUrl}>{copied?'‚úì Copied!':'Copy Link'}</button></div>
        <button className="btn btn-primary" onClick={enterAuction} style={{marginTop:'20px',width:'100%'}}>ENTER AUCTION ‚Üí</button>
      </div></div>

      <div className="card"><div className="card-header">Access Codes</div><div className="card-body">
        <div className="form-row">
          <div><label style={{fontSize:'13px',fontWeight:600,color:'var(--espn-text-secondary)',textTransform:'uppercase',marginBottom:'8px',display:'block'}}>League Access Code</label><p style={{fontSize:'18px',fontWeight:700,color:'var(--espn-blue)'}}>{league.leagueAccessCode}</p><p style={{fontSize:'13px',color:'var(--espn-text-muted)',marginTop:'4px'}}>Share with all league members</p></div>
          <div><label style={{fontSize:'13px',fontWeight:600,color:'var(--espn-text-secondary)',textTransform:'uppercase',marginBottom:'8px',display:'block'}}>Commissioner Access Code</label><p style={{fontSize:'18px',fontWeight:700,color:'var(--espn-orange)'}}>{league.commissionerAccessCode}</p><p style={{fontSize:'13px',color:'var(--espn-text-muted)',marginTop:'4px'}}>Only for commissioners</p></div>
        </div>
      </div></div>

      {hasResults&&<div className="card"><div className="card-header">Bidding Results</div><div className="card-body">
        <p style={{marginBottom:'16px',color:'var(--espn-text-secondary)'}}>Access auction results and bid history:</p>
        <div style={{display:'flex',gap:'12px'}}>
          {sheetsUrl&&<button className="btn btn-primary" onClick={()=>window.open(sheetsUrl,'_blank')} style={{flex:1}}>üìä Open Google Sheet</button>}
          <button className="btn btn-secondary" onClick={()=>window.open(getUrl(),'_blank')} style={{flex:1}}>üì• Download CSV</button>
        </div>
      </div></div>}

      <div className="card"><div className="card-header">League Summary</div><div className="card-body">
        <div className="form-row">
          <div><p style={{marginBottom:'10px'}}><strong>Teams:</strong> {league.teams?Object.keys(league.teams).length:0}</p><p style={{marginBottom:'10px'}}><strong>Players:</strong> {league.players?league.players.length:0}</p></div>
          <div><p style={{marginBottom:'10px'}}><strong>Timer:</strong> {league.timerDuration}s</p><p style={{marginBottom:'10px'}}><strong>Google Sheets:</strong> {league.sheetsConfig?'‚úì Configured':'Not configured'}</p></div>
        </div>
      </div></div>

      <div style={{display:'flex',gap:'16px',marginTop:'32px'}}>
        <button className="btn btn-secondary" onClick={onBack} style={{flex:1}}>‚Üê Back to Dashboard</button>
        <button className="btn btn-blue" onClick={onEdit} style={{flex:1}}>Edit League Settings</button>
      </div>
    </main>
  </>;
}

// Main App Component
function App(){
  const[admin,setAdmin]=useState(null);
  const[view,setView]=useState('login');
  const[currentLeagueId,setCurrentLeagueId]=useState(null);

  useEffect(()=>{const stored=localStorage.getItem(STORE);if(stored){try{const adminData=JSON.parse(stored);setAdmin(adminData);setView('dashboard')}catch(e){}}},[]);

  const handleLogin=(adminData)=>{
    setAdmin(adminData);
    setView('dashboard');
    localStorage.setItem(STORE,JSON.stringify(adminData));
  };

  const handleLogout=()=>{
    setAdmin(null);
    setView('login');
    localStorage.removeItem(STORE);
  };

  const handleCreateNew=()=>{
    setCurrentLeagueId(null);
    setView('setup');
  };

  const handleSelectLeague=(leagueId)=>{
    setCurrentLeagueId(leagueId);
    setView('setup');
  };

  const handleComplete=(leagueId,leagueName)=>{
    setCurrentLeagueId(leagueId);
    setView('manage');
  };

  const handleBackToDashboard=()=>{
    setCurrentLeagueId(null);
    setView('dashboard');
  };

  if(view==='login')return<AdminLogin onLogin={handleLogin}/>;
  if(view==='dashboard')return<LeagueDashboard admin={admin} onSelectLeague={handleSelectLeague} onCreateNew={handleCreateNew} onLogout={handleLogout}/>;
  if(view==='setup')return<CommissionerSetup admin={admin} leagueId={currentLeagueId} onComplete={handleComplete} onBack={handleBackToDashboard}/>;
  if(view==='manage')return<LeagueManagement leagueId={currentLeagueId} onBack={handleBackToDashboard} onEdit={()=>setView('setup')}/>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
